<?xml version="1.0" encoding="UTF-8"?>
<project name="ant-intellij-tasks" default="build">

    <!-- Import ant-intellij-tasks -->
    <taskdef resource="com/tomergabel/build/intellij/ant/antlib.xml"
             classpath="lib/ant-intellij-tasks.jar"/>
    <!-- Import ant-contrib -->
    <taskdef resource="net/sf/antcontrib/antlib.xml"
             classpath="lib/ant-contrib.jar"/>

    <!-- Globals -->
    <!-- TODO: replace with lookup -->
    <property name="module-file" value="ant-intellij-tasks.iml"/>
    <property name="project-file" value="ant-intellij-tasks.ipr"/>

    <!-- Forward declarations -->
    <property name="idea.moduledeps" value=""/>
    <property name="idea.output" value=""/>
    <property name="idea.sources" value=""/>

    <!-- Targets -->

    <target name="build-deps" depends="resolve-deps">
        <for list="${idea.moduledeps}" param="dependency">
            <sequential>
                <ant antfile="${dependency}"/>
            </sequential>
        </for>
    </target>

    <target name="clean" depends="resolve-output">
        <delete dir="${idea.output}" includes="**" />
    </target>

    <target name="resolve-core" depends="resolve-output, resolve-classpath, resolve-sources-core, resolve-deps"/>
    <target name="resolve-all" depends="resolve-core, resolve-sources-test" />

    <target name="resolve-output">
        <resolveOutputDirectory property="idea.output" projectfile="${project-file}" modulefile="${module-file}"/>
    </target>
    <target name="resolve-sources-core">
        <resolveSourceDirectories pathid="idea.sources" filter="source" projectfile="${project-file}" modulefile="${module-file}"/>
    </target>
    <target name="resolve-sources-test">
        <resolveSourceDirectories pathid="idea.sources" filter="test" projectfile="${project-file}" modulefile="${module-file}"/>
    </target>
    <target name="resolve-classpath">
        <resolveModuleClasspath pathid="idea.classpath" projectfile="${project-file}" modulefile="${module-file}"/>
    </target>
    <target name="resolve-deps">
        <resolveModuleDependencies mode="descriptors" property="idea.moduledeps" projectfile="${project-file}"
                                   srcfile="${module-file}"/>
    </target>

    <target name="build" depends="build-core" />

    <target name="build-core" depends="resolve-core, build-deps">
        <!-- Build module -->
        <javac destdir="${idea.output}"
               classpathref="idea.classpath"
               debug="true" encoding="utf-8">
            <src refid="idea.sources"/>
        </javac>
    </target>
    <target name="build-all" depends="resolve-all, build-deps">
        <!-- Build module -->
        <javac destdir="${idea.output}"
               classpathref="idea.classpath"
               debug="true" encoding="utf-8">
            <src refid="idea.sources"/>
        </javac>
    </target>

    <target name="test" depends="build-all">
        <junit>
            <formatter type="plain" usefile="false" />
            <classpath><path refid="project.classpath"/></classpath>
            <batchtest>
                <fileset dir="${idea.testsources}" includes="**/*Test*.java" />
            </batchtest>

        </junit>
    </target>

</project>