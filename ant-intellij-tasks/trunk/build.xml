<?xml version="1.0" encoding="UTF-8"?>
<project name="ant-intellij-tasks" default="build">

    <!-- Import ant-intellij-tasks -->
    <taskdef resource="com/tomergabel/build/intellij/ant/antlib.xml"
             classpath="lib/ant-intellij-tasks.jar" />
    <!-- Import ant-contrib -->
    <taskdef resource="net/sf/antcontrib/antlib.xml"
             classpath="lib/ant-contrib.jar" />

    <!-- Globals -->
    <!-- TODO: replace with lookup -->
    <property name="module-file" value="ant-intellij-tasks.iml" />
    <property name="project-file" value="ant-intellij-tasks.ipr" />

    <!-- Forward declarations -->
    <property name="idea.moduledeps" value="" />
    <property name="idea.output" value="" />
    <property name="idea.sources" value="" />

    <!-- Targets -->

    <target name="resolve-deps">
        <resolveModuleDependencies mode="DESCRIPTORS" property="idea.moduledeps"
                                   projectfile="${project-file}" srcfile="${module-file}" />
    </target>

    <target name="build-deps" depends="resolve-deps">
        <for list="${idea.moduledeps}" param="dependency">
            <sequential>
                <ant antfile="${dependency}" />
            </sequential>
        </for>
    </target>

    <target name="build" depends="build-deps">

        <!-- Resolve module details -->
        <resolveOutputDirectory   property="idea.output"    projectfile="${project-file}" srcfile="${module-file}" />
        <resolveSourceDirectories pathid  ="idea.sources"   projectfile="${project-file}" srcfile="${module-file}" />
        <resolveModuleClasspath   pathid  ="idea.classpath" projectfile="${project-file}" srcfile="${module-file}" />

        <!-- Build module -->
        <javac sourcepath="${idea.sources}"
               destdir="${idea.output}"
               classpathref="idea.classpath"
               debug="true" encoding="utf-8" />
    </target>

</project>